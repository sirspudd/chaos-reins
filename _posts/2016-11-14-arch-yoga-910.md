---
layout: post
title:  "Install Arch on the Lenovo Yoga 910"
date:   2016-11-14 12:10:59 -0700
published: true
tags: [ArchLinux, Lenovo, 910, Yoga]
---

# TL&DR

* Everything can be trivially made to work but the Validity fingerprint sensor.
* Wifi requires
  * ideapad_laptop to remove the hardware block (present in 4.9 tree), blacklisting this module in 4.8 removes the hardware block, but might carry other costs
  * Firmware from this [repo](https://github.com/kvalo/ath10k-firmware) which replaces the crap in /usr/lib/firmware/ath10k/QCA6174/hw3.0. (Don't worry, this muppet is the canonical source of firmware for these cards)
* Video requires enable_rc6=0 to avoid booting to skittish artifacts (or no modesetting, but that is way more intrusive)
* Machine runs well and looks good

# Verbose instructions

1. Get to the EFI/bios configuration. I got there via going to recovery options in Windows and rebooting to the EFI settings panel. I could not get there via any other mechanism. Once in the bios, enable AHCI support for the disk, disable secure boot and reset setup keys. (I had to do this in order for the Linux kernel to boot, or it would ceaselessly prompt me to add the kernel hash to the EFI array of trusted hashes.
2. After this, a standard Arch boot [stick](https://wiki.archlinux.org/index.php/USB_flash_installation_media) will get you to the command line (this assumes no mode setting, as mode setting on this hardware introduces artifacts unless you pass enable_rc6=0 on the kernel cmdline)
3. I used a wired network to do the initial provisioning as documented in the Arch install documentation
4. I personally recommend systemd-bootd, here is my Arch boot entry:/boot/loader/entries/arch.conf:
        title arch
        linux /vmlinuz-linux
        initrd /intel-ucode.img
        initrd /initramfs-linux.img
        options root=PARTUUID=8457d2b8-ba4a-4f9b-9098-03241bdbd20f rw i915.enable_rc6=0 pci=noaer quiet splash
5. Wifi is the only sticking point as noted above, and requires you to address both points articulated above. This is what healthy dmesg output for the ath10k module looks like:

        [    3.425555] ath10k_pci 0000:01:00.0: pci irq msi oper_irq_mode 2 irq_mode 0 reset_mode 0
        [    3.688718] ath10k_pci 0000:01:00.0: Direct firmware load for ath10k/pre-cal-pci-0000:01:00.0.bin failed with error -2
        [    3.688727] ath10k_pci 0000:01:00.0: Direct firmware load for ath10k/cal-pci-0000:01:00.0.bin failed with error -2
        [    3.689533] ath10k_pci 0000:01:00.0: Direct firmware load for ath10k/QCA6174/hw3.0/firmware-5.bin failed with error -2
        [    3.689536] ath10k_pci 0000:01:00.0: could not fetch firmware file 'ath10k/QCA6174/hw3.0/firmware-5.bin': -2
        [    3.691039] ath10k_pci 0000:01:00.0: qca6174 hw3.2 target 0x05030000 chip_id 0x00340aff sub 17aa:0827
        [    3.691041] ath10k_pci 0000:01:00.0: kconfig debug 0 debugfs 1 tracing 0 dfs 0 testmode 0
        [    3.691439] ath10k_pci 0000:01:00.0: firmware ver WLAN.RM.2.0-00180-QCARMSWPZ-1 api 4 features wowlan,ignore-otp,no-4addr-pad crc32 75dee6c5
        [    3.755748] ath10k_pci 0000:01:00.0: board_file api 2 bmi_id N/A crc32 6fc88fe7
        [    5.921449] ath10k_pci 0000:01:00.0: htt-ver 3.26 wmi-op 4 htt-op 3 cal otp max-sta 32 raw 0 hwcrypto 1
        [    6.005216] ath10k_pci 0000:01:00.0 wlp1s0: renamed from wlan0

I kept on chasing the firmware-5.bin dragon for a while, but wifi works, so who gives a flying fig. The output of rfkill is way more important, as the hardware lock ends all dialogue.
6. Those complications aside, everything is working and functioning at peak performance.

# Comments

* My Backspace key arrived feeling slightly broken and lobsided. Anything other than a direct strike failed to register on the key, and pressing on the bottom makes the top rise up, which feels a little broken.
* Touchpad feels good, screen looks good if a little glossy. Gnome looks really good at 1080p on a 13.9 inch screen

# Raw dumps

## lspci

```
00:00.0 Host bridge: Intel Corporation Device 5904 (rev 02)
00:02.0 VGA compatible controller: Intel Corporation Device 5916 (rev 02)
00:04.0 Signal processing controller: Intel Corporation Skylake Processor Thermal Subsystem (rev 02)
00:08.0 System peripheral: Intel Corporation Skylake Gaussian Mixture Model
00:14.0 USB controller: Intel Corporation Sunrise Point-LP USB 3.0 xHCI Controller (rev 21)
00:14.2 Signal processing controller: Intel Corporation Sunrise Point-LP Thermal subsystem (rev 21)
00:15.0 Signal processing controller: Intel Corporation Sunrise Point-LP Serial IO I2C Controller #0 (rev 21)
00:15.1 Signal processing controller: Intel Corporation Sunrise Point-LP Serial IO I2C Controller #1 (rev 21)
00:15.3 Signal processing controller: Intel Corporation Sunrise Point-LP Serial IO I2C Controller #3 (rev 21)
00:16.0 Communication controller: Intel Corporation Sunrise Point-LP CSME HECI #1 (rev 21)
00:1c.0 PCI bridge: Intel Corporation Sunrise Point-LP PCI Express Root Port #5 (rev f1)
00:1d.0 PCI bridge: Intel Corporation Device 9d18 (rev f1)
00:1f.0 ISA bridge: Intel Corporation Device 9d58 (rev 21)
00:1f.2 Memory controller: Intel Corporation Sunrise Point-LP PMC (rev 21)
00:1f.3 Audio device: Intel Corporation Device 9d71 (rev 21)
00:1f.4 SMBus: Intel Corporation Sunrise Point-LP SMBus (rev 21)
01:00.0 Network controller: Qualcomm Atheros QCA6174 802.11ac Wireless Network Adapter (rev 32)
02:00.0 Non-Volatile memory controller: Samsung Electronics Co Ltd NVMe SSD Controller (rev 01)
```

## lsusb

```
Bus 002 Device 001: ID 1d6b:0003 Linux Foundation 3.0 root hub
Bus 001 Device 004: ID 0cf3:e300 Atheros Communications, Inc. 
Bus 001 Device 003: ID 138a:0094 Validity Sensors, Inc. 
Bus 001 Device 002: ID 04f2:b5a4 Chicony Electronics Co., Ltd 
Bus 001 Device 001: ID 1d6b:0002 Linux Foundation 2.0 root hub
```

## rfkill

```
0: hci0: Bluetooth
	Soft blocked: no
	Hard blocked: no
1: phy0: Wireless LAN
	Soft blocked: no
	Hard blocked: no
```
