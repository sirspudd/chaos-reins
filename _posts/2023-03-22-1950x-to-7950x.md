---
title:  "Moving from a 1950x to a 7950x"
date:   2023-03-22 12:10:59 -0700
published: true
tags: [clang, llvm, linux, oss, lto, 1950x, 7950x, amd, arch]
---

# setup

* 7950x
* ASUS System Product Name/ROG STRIX B650E-E GAMING WIFI, BIOS 1222 02/24/2023

# Issues

The integrated NIC dies after some period of usage, for me it normally takes a couple days

```
Apr 09 14:55:36 wolf kernel: ---[ end trace 0000000000000000 ]---
Apr 09 14:55:36 wolf kernel:  </TASK>
Apr 09 14:55:36 wolf kernel:  ret_from_fork+0x29/0x50
Apr 09 14:55:36 wolf kernel:  ? __cfi_kthread+0x10/0x10
Apr 09 14:55:36 wolf kernel:  kthread+0x148/0x170
Apr 09 14:55:36 wolf kernel:  ? __cfi_worker_thread+0x10/0x10
Apr 09 14:55:36 wolf kernel:  worker_thread+0x24d/0x540
Apr 09 14:55:36 wolf kernel:  process_one_work+0x1f6/0x3a0
Apr 09 14:55:36 wolf kernel:  igc_watchdog_task+0x3d0/0x640
Apr 09 14:55:36 wolf kernel:  <TASK>
Apr 09 14:55:36 wolf kernel: Call Trace:
Apr 09 14:55:36 wolf kernel: PKRU: 55555554
Apr 09 14:55:36 wolf kernel: CR2: 00000e9400358000 CR3: 000000011cb14000 CR4: 0000000000750ef0
Apr 09 14:55:36 wolf kernel: CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
Apr 09 14:55:36 wolf kernel: FS:  0000000000000000(0000) GS:ffff892258200000(0000) knlGS:0000000000000000
Apr 09 14:55:36 wolf kernel: R13: 0000000000000000 R14: 0000000000000000 R15: ffff891347809c80
Apr 09 14:55:36 wolf kernel: R10: 0000000000005ffd R11: 0000000000000004 R12: 0000000000000000
Apr 09 14:55:36 wolf kernel: RBP: 000000000000c030 R08: 0000000000001fff R09: ffff892297f78c40
Apr 09 14:55:36 wolf kernel: RDX: ffff891630dabd00 RSI: 0000000000000002 RDI: ffff892258220708
Apr 09 14:55:36 wolf kernel: RAX: 000000000000001f RBX: ffff89134b80c900 RCX: 0000000000000027
Apr 09 14:55:36 wolf kernel: RSP: 0018:ffff891630dabe20 EFLAGS: 00010282
Apr 09 14:55:36 wolf kernel: Code: 00 e8 9e 1b 72 ff 84 c0 75 12 b8 ff ff ff ff 31 f6 83 bb 0c 03 00 00 00 75 91 eb a1 48 c7 c7 6a d5 34 88 89 ee e8 6a 1e ee fe <0f> 0b eb d>
Apr 09 14:55:36 wolf kernel: RIP: 0010:igc_update_stats+0x136/0x2060
Apr 09 14:55:36 wolf kernel: Workqueue: events igc_watchdog_task
Apr 09 14:55:36 wolf kernel: Hardware name: ASUS System Product Name/ROG STRIX B650E-E GAMING WIFI, BIOS 1222 02/24/2023
Apr 09 14:55:36 wolf kernel: CPU: 0 PID: 311954 Comm: kworker/0:0 Not tainted 6.3.0-rc5-00147-gd793de9ff55e #1
Apr 09 14:55:36 wolf kernel: Modules linked in: nft_compat nft_chain_nat nf_tables overlay snd_hda_codec_hdmi snd_usb_audio snd_hda_intel snd_intel_dspcfg snd_intel_sdw_acpi>
Apr 09 14:55:36 wolf kernel: WARNING: CPU: 0 PID: 311954 at drivers/net/ethernet/intel/igc/igc_main.c:6440 igc_update_stats+0x136/0x2060
Apr 09 14:55:36 wolf kernel: igc: Failed to read reg 0xc030!
Apr 09 14:55:36 wolf kernel: ------------[ cut here ]------------
```

# Compilation tests

## clang 16

* ssh+git://aur@aur.archlinux.org/clang-prefixed-release.git a2f45f1d540c48ea29f2a5ae9f5aae6ec16ca4fb
* compiled with system clang (clang version 15.0.7) on tmpfs
* time ninja -C _build times below

```
    cmake   -B _build \
            -GNinja \
            -DCLANG_DEFAULT_PIE_ON_LINUX=ON \
            -DLLVM_USE_LINKER=lld \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_INSTALL_PREFIX:PATH=${install_path} \
            -DCMAKE_EXE_LINKER_FLAGS=-Wl,-Bsymbolic-functions \
            -DCMAKE_SHARED_LINKER_FLAGS=-Wl,-Bsymbolic-functions \
            -DLLVM_ENABLE_LTO=Thin \
            -DLLVM_LINK_LLVM_DYLIB=ON \
            -DCLANG_LINK_CLANG_DYLIB=ON \
            -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;libc;libclc;lld;lldb;openmp;polly;pstl;compiler-rt" \
            -DLLVM_ENABLE_RUNTIMES="libcxx;libcxxabi;libunwind" \
            -DCMAKE_BUILD_TYPE=Release \
            ${srcdir}/llvm-project-${_pkgver_suffix}.src/llvm
```

### 1950x

* real    32m13.941s
* user    902m39.411s
* sys     27m10.580s

### 7950x

* real    13m33.882s
* user    373m1.014s
* sys 10m37.541s

### 7950x (105W eco mode, wd black 850X, mitigations enabled, -Os, amd_pstate_epp)

* real    13m41.037s
* user    390m44.339s
* sys 10m28.171s

### 7950x (105W eco mode, wd black 850X, mitigations enabled, -O3 kernel, amd_pstate_epp)

* real    13m21.529s
* user    386m30.702s
* sys 9m51.296s

### 3970X (external data point, virtualized Arch)

* real 12m20.354s
* user 589m38.820s
* sys 23m20.499s

### 7950xV3D (external data point, stock Arch, 105w eco mode, no fan control (so they are controlled by the mainboard => more or less 100% rpm)

* real    12m42.236s
* user    365m26.552s
* sys     10m45.814s

## linux 5.3-rc2+

* https://code.chaos-reins.com/sirspudd/linux-spudd2
* built using the clang above
* not true apples to apples; 1950x is on xfs, 7950x is on btrfs

### 1950x

* real    6m42.707s
* user    148m39.721s
* sys     12m27.441s

### 7950x

* real    3m13.105s
* user    62m42.206s
* sys 6m9.223s

## Qt 6.5 rc

* ssh+git://aur@aur.archlinux.org/qt-sdk.git
* compiled with system gcc (gcc version 12.2.1 20230201 (GCC)) on tmpfs
* time cmake --build . --parallel
* using the mold linker

### 1950x

* real    26m44.210s
* user    662m7.958s
* sys 54m8.554s

### 7950x, tmpfs (smart meter says 330W during compile; ~85-90C ccd temp)

* real    10m19.257s
* user    266m58.632s
* sys 19m26.520s

### 7950x 105W eco mode, tmpfs (smart meter says 256W during compile; ~65C ccd temp)

* real    10m34.123s
* user    275m15.023s
* sys 18m55.530s

### 7950x 105W eco mode, wd black 850X

* real    10m31.846s
* user    275m44.005s
* sys 18m17.431s

### 7950x 105W eco mode, wd black 850X, stock Arch kernel

* real    11m44.165s
* user    295m28.822s
* sys 23m21.878s

### 7950x 105W eco mode, wd black 850X (disabled numa, -Os)

* real    10m53.142s
* user    279m49.306s
* sys 18m31.069s

### 7950x 105W eco mode, wd black 850X (mitigations enabled, -Os)

* real    10m39.039s
* user    276m52.122s
* sys 18m36.332s

# random benchmarks

## cryptsetup benchmark

### 1950x
```
# Tests are approximate using memory only (no storage IO).
PBKDF2-sha1      1716163 iterations per second for 256-bit key
PBKDF2-sha256    3266591 iterations per second for 256-bit key
PBKDF2-sha512    1358259 iterations per second for 256-bit key
PBKDF2-ripemd160  784862 iterations per second for 256-bit key
PBKDF2-whirlpool  603323 iterations per second for 256-bit key
argon2i       6 iterations, 1048576 memory, 4 parallel threads (CPUs) for 256-bit key (requested 2000 ms time)
argon2id      6 iterations, 1048576 memory, 4 parallel threads (CPUs) for 256-bit key (requested 2000 ms time)
#     Algorithm |       Key |      Encryption |      Decryption
        aes-cbc        128b      1104.9 MiB/s      3192.5 MiB/s
    serpent-cbc        128b       105.5 MiB/s       382.4 MiB/s
    twofish-cbc        128b       212.9 MiB/s       397.1 MiB/s
        aes-cbc        256b       855.9 MiB/s      2820.6 MiB/s
    serpent-cbc        256b       108.9 MiB/s       378.3 MiB/s
    twofish-cbc        256b       216.2 MiB/s       381.9 MiB/s
        aes-xts        256b      2748.6 MiB/s      2771.5 MiB/s
    serpent-xts        256b       338.3 MiB/s       356.2 MiB/s
    twofish-xts        256b       370.3 MiB/s       371.9 MiB/s
        aes-xts        512b      2412.1 MiB/s      2416.3 MiB/s
    serpent-xts        512b       367.3 MiB/s       360.4 MiB/s
    twofish-xts        512b       373.8 MiB/s       367.6 MiB/s
```
### 7950x
```
# Tests are approximate using memory only (no storage IO).
PBKDF2-sha1      3628290 iterations per second for 256-bit key
PBKDF2-sha256    6678828 iterations per second for 256-bit key
PBKDF2-sha512    2706002 iterations per second for 256-bit key
PBKDF2-ripemd160 1347784 iterations per second for 256-bit key
PBKDF2-whirlpool 1016062 iterations per second for 256-bit key
argon2i      16 iterations, 1048576 memory, 4 parallel threads (CPUs) for 256-bit key (requested 2000 ms time)
argon2id     16 iterations, 1048576 memory, 4 parallel threads (CPUs) for 256-bit key (requested 2000 ms time)
#     Algorithm |       Key |      Encryption |      Decryption
        aes-cbc        128b      1750.4 MiB/s      8215.9 MiB/s
    serpent-cbc        128b       164.1 MiB/s      1237.1 MiB/s
    twofish-cbc        128b       330.1 MiB/s       738.8 MiB/s
        aes-cbc        256b      1346.1 MiB/s      6540.4 MiB/s
    serpent-cbc        256b       168.1 MiB/s      1237.4 MiB/s
    twofish-cbc        256b       336.3 MiB/s       737.6 MiB/s
        aes-xts        256b      6821.6 MiB/s      6807.3 MiB/s
    serpent-xts        256b      1074.6 MiB/s      1095.0 MiB/s
    twofish-xts        256b       685.3 MiB/s       695.2 MiB/s
        aes-xts        512b      5648.3 MiB/s      5609.5 MiB/s
    serpent-xts        512b      1107.9 MiB/s      1096.2 MiB/s
    twofish-xts        512b       686.7 MiB/s       694.1 MiB/s
```
